<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="TEZ402 is a reference implementation for x402 Payment Required flow with Permit2 and facilitator-sponsored gas on Etherlink.">
    <meta property="og:title" content="TEZ402 // PERMIT2 UPLINK">
    <meta property="og:description" content="Test x402 + Permit2 payments on Etherlink with facilitator-sponsored gas.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tez402.bubbletez.com">
    <meta property="og:image" content="https://www.etherlink.com/favicon.ico">
    <link rel="icon" href="https://www.etherlink.com/favicon.ico" sizes="any">
    <title>TEZ402 // PERMIT2 UPLINK</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-S1FE79SC2W"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/wallet_connect_poc.css?v=20260225-feedback-triage-1">
</head>
<body>

<div id="disclaimer-overlay" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-title">Usage Notice</div>
        <div class="modal-body">
            While x402 is an open and neutral standard, this website is maintained by TZ APAC. By using this site, you agree to be bound by the <a class="modal-link" href="https://tzapac.notion.site/BubbleTez-Terms-of-Service-310c42813a8a80c5bceccc9ac7760cb7?pvs=143" target="_blank" rel="noopener noreferrer">Terms of Service</a> and Privacy policy.
        </div>
        <div class="modal-actions">
            <button id="disclaimer-ok-btn" type="button">I UNDERSTAND</button>
        </div>
    </div>
</div>

<div class="container">
    <header>
        <div class="header-main">
            <h1>TEZ402 // PERMIT2 UPLINK <span class="beta-badge">BETA</span></h1>
            <p class="subtitle">Reference implementation for x402 payments, Permit2 signing, and facilitator-sponsored gas.</p>
            <p class="value-prop">Accept crypto payments with zero gas costs for end users. Settle on-chain. Stay compliant.</p>
            <p class="subtitle">Evaluation path: run the 5-step demo, then use Quick Start to deploy your own stack.</p>
        </div>
        <div class="header-side">
            <div class="status-indicator">
                <div id="status-dot" class="status-dot"></div>
                <span id="status-text">OFFLINE</span>
            </div>
            <a class="header-link" href="https://github.com/tzapac/tzapac-x402-permit2" target="_blank" rel="noopener noreferrer">GitHub Repository</a>
            <a class="header-link" href="https://github.com/tzapac/tzapac-x402-permit2/blob/main/docs/quick_start.md" target="_blank" rel="noopener noreferrer">Quick Start</a>
            <a class="header-link" href="https://github.com/tzapac/tzapac-x402-permit2/issues/new/choose" target="_blank" rel="noopener noreferrer">Request Pilot / Contact</a>
        </div>
    </header>

    <div class="trust-strip">
        <div class="trust-item"><span class="trust-label">x402 Spec</span><span class="trust-value"><a class="trust-link" href="https://github.com/coinbase/x402" target="_blank" rel="noopener noreferrer">v2 reference</a></span></div>
        <div class="trust-item"><span class="trust-label">Chain</span><span class="trust-value">Etherlink (42793)</span></div>
        <div class="trust-item"><span class="trust-label">Settlement</span><span class="trust-value">Permit2</span></div>
        <div class="trust-item"><span class="trust-label">Gas Model</span><span class="trust-value">Facilitator Sponsored</span></div>
    </div>

        <div class="tab-bar">
        <button class="tab-button active" data-tab="overview">Overview</button>
        <button class="tab-button" data-tab="demo">Demo</button>
        <button class="tab-button" data-tab="integration">Integration Guide</button>
        <button class="tab-button" data-tab="setup">Setup Instructions</button>
        <button class="tab-button" data-tab="docs">Docs</button>
        <button class="tab-button" data-tab="legal">FAQ / Legal</button>
    </div>

    <div class="tab-panel" data-panel="overview">
        <div class="content">
            <div class="guide-block">
                <div class="guide-title">Choose Your Role</div>
                <div class="role-selector" id="role-selector">
                    <button id="role-client-btn" class="role-button active" data-role="client">Client Integrator</button>
                    <button id="role-store-btn" class="role-button" data-role="store">Store Operator</button>
                    <button id="role-facilitator-btn" class="role-button" data-role="facilitator">Facilitator Host</button>
                </div>
                <div id="role-summary" class="guide-text role-summary"></div>
            </div>

            <div class="role-panels">
                <div class="guide-block" data-role-panel="client">
                    <div class="guide-title">Client Integrator Focus</div>
                    <ul class="guide-list">
                        <li>Detect `HTTP 402 Payment Required`.</li>
                        <li>Parse the `Payment-Required` payload and select supported method (`permit2`).</li>
                        <li>Sign Permit2 typed data and retry the protected endpoint with `Payment-Signature`.</li>
                    </ul>
                </div>
                <div class="guide-block hidden" data-role-panel="store">
                    <div class="guide-title">Store Operator Focus</div>
                    <ul class="guide-list">
                        <li>Protect resources and return standards-compliant 402 requirements.</li>
                        <li>Validate signed payment payload against expected terms.</li>
                        <li>Call facilitator settlement endpoint and only release resource on success.</li>
                    </ul>
                </div>
                <div class="guide-block hidden" data-role-panel="facilitator">
                    <div class="guide-title">Facilitator Host Focus</div>
                    <ul class="guide-list">
                        <li>Validate payloads and enforce allowlist/codehash checks.</li>
                        <li>Sponsor gas and execute settlement transactions against Permit2 proxy.</li>
                        <li>Expose reliable `/health`, `/supported`, `/settle` endpoints for store calls.</li>
                    </ul>
                </div>
            </div>

            <div class="guide-block">
                <div class="guide-title">How the Flow Works</div>
                <pre>Client App
  -&gt; GET /protected-resource
Store API
  -&gt; 402 Payment Required + x402 payment requirement
Client App
  -&gt; signs Permit2 typed data (off-chain)
Client App
  -&gt; retries resource request with Payment-Signature
Store API
  -&gt; calls Facilitator /settle
Facilitator
  -&gt; sponsors gas + executes Permit2 settlement on-chain
Store API
  -&gt; returns protected resource</pre>
                <ol class="guide-list ordered-list">
                    <li>Client requests protected resource.</li>
                    <li>Store responds with 402 and exact payment requirement.</li>
                    <li>Client signs Permit2 authorization matching store terms.</li>
                    <li>Facilitator validates and settles on-chain while paying gas.</li>
                    <li>Store verifies settlement and serves content.</li>
                </ol>
            </div>

            <div class="guide-block">
                <div class="guide-title">On-Chain Endpoints &amp; References</div>
                <div class="address-row"><span class="address-label">Chain ID</span><span class="address-value">42793</span></div>
                <div class="address-row"><span class="address-label">Permit2</span><span id="address-permit2" class="address-value"><a class="address-link" href="https://explorer.etherlink.com/address/0x000000000022D473030F116dDEE9F6B43aC78BA3" target="_blank" rel="noopener noreferrer">0x000000000022D473030F116dDEE9F6B43aC78BA3</a></span><button class="mini-btn copy-btn" data-copy-target="address-permit2">Copy</button></div>
                <div class="address-row"><span class="address-label">x402 Proxy</span><span id="address-x402-proxy" class="address-value"><a class="address-link" href="https://explorer.etherlink.com/address/0xB6FD384A0626BfeF85f3dBaf5223Dd964684B09E" target="_blank" rel="noopener noreferrer">0xB6FD384A0626BfeF85f3dBaf5223Dd964684B09E</a></span><button class="mini-btn copy-btn" data-copy-target="address-x402-proxy">Copy</button></div>
                <div class="address-row"><span class="address-label">BBT Token</span><span id="address-token" class="address-value"><a class="address-link" href="https://explorer.etherlink.com/address/0x7EfE4bdd11237610bcFca478937658bE39F8dfd6" target="_blank" rel="noopener noreferrer">0x7EfE4bdd11237610bcFca478937658bE39F8dfd6</a></span><button class="mini-btn copy-btn" data-copy-target="address-token">Copy</button></div>
                <div class="address-row"><span class="address-label">Public Facilitator (Current)</span><span id="address-facilitator" class="address-value">https://exp-faci.bubbletez.com</span><button class="mini-btn copy-btn" data-copy-target="address-facilitator">Copy</button></div>
                <div class="address-row"><span class="address-label">Public Store (Current)</span><span id="address-store" class="address-value">https://tez402.bubbletez.com/api/weather</span><button class="mini-btn copy-btn" data-copy-target="address-store">Copy</button></div>
                <p class="guide-text">Gas sponsored means the user signs authorization; the facilitator submits and pays network gas for settlement execution.</p>
                <p class="guide-text">BBT is the sample ERC-20 token used by this beta flow. See the <a class="guide-link" href="https://github.com/tzapac/tzapac-x402-permit2/blob/main/docs/bbt_token_reference.md" target="_blank" rel="noopener noreferrer">BBT token reference</a> for contract details.</p>
                <p class="guide-text">No public faucet is bundled in this beta. If you do not have BBT, either test with your own ERC-20 using Custom Token Product in Demo Step 3, or request test allocation via <a class="guide-link" href="https://github.com/tzapac/tzapac-x402-permit2/issues/new/choose" target="_blank" rel="noopener noreferrer">GitHub issue</a>.</p>
                <p class="guide-text">How this compares with upstream Coinbase behavior: <a class="guide-link" href="https://github.com/tzapac/tzapac-x402-permit2/blob/main/docs/coinbase_comparison.md" target="_blank" rel="noopener noreferrer">Coinbase comparison report</a>.</p>
            </div>

            <div class="actions compact-actions">
                <button id="go-demo-btn">Open Demo</button>
                <button id="go-integration-btn">Open Integration Guide</button>
                <button id="go-setup-btn">Open Setup Instructions</button>
            </div>
        </div>
    </div>

    <div class="tab-panel hidden" data-panel="demo">
        <div class="content">
            <div class="guide-block">
                <div class="guide-title">Interactive Demo (End-to-End)</div>
                <div class="guide-text">This demo runs the exact 5-step payment flow with facilitator-sponsored gas.</div>
                <div id="ethers-load-status" class="ethers-load-status loading">Loading dependencies...</div>
                <div class="actions compact-actions">
                    <button id="reset-demo-btn" type="button">RESET DEMO</button>
                </div>
            </div>

            <div class="step-card" data-step="1">
                <div class="step-head">
                    <div class="step-title">Step 1: Connect Wallet</div>
                    <span id="step-status-1" class="step-status pending">Not started</span>
                </div>
                <p class="guide-text">What happens: initialize provider and load selected account context.</p>
                <p class="guide-text">On-chain interaction: none.</p>
                <p class="guide-text">Supported wallets: EIP-1193 injected providers (MetaMask, Rabby, Frame). WalletConnect support is not yet included in this beta.</p>
                <div class="actions compact-actions">
                    <button id="connect-btn">1. CONNECT WALLET</button>
                </div>
                <div id="wallet-section">
                    <div class="data-row"><span class="data-label">Network</span><span id="network-display" class="data-value">--</span></div>
                    <div class="data-row"><span class="data-label">Account</span><span id="account-display" class="data-value address">--</span></div>
                </div>
            </div>

            <div class="step-card" data-step="2">
                <div class="step-head">
                    <div class="step-title">Step 2: Check Facilitator Health</div>
                    <span id="step-status-2" class="step-status pending">Not started</span>
                </div>
                <p class="guide-text">What happens: call facilitator `/health` and confirm chain support.</p>
                <p class="guide-text">On-chain interaction: none.</p>
                <div id="facilitator-section">
                    <div class="data-row">
                        <span class="data-label">Facilitator URL</span>
                        <span class="data-value address"><input id="facilitator-input" class="text-input" type="text" value="https://exp-faci.bubbletez.com" placeholder="Current endpoint: https://exp-faci.bubbletez.com" /></span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Facilitator Spender</span>
                        <span class="data-value address"><input id="spender-input" class="text-input" type="text" value="0xB6FD384A0626BfeF85f3dBaf5223Dd964684B09E" placeholder="0x... (x402 proxy address)" /></span>
                    </div>
                </div>
                <div class="actions compact-actions">
                    <button id="health-btn">2. CHECK /HEALTH</button>
                </div>
                <pre id="health-response" class="response-preview">Awaiting response...</pre>
            </div>

            <div class="step-card" data-step="3">
                <div class="step-head">
                    <div class="step-title">Step 3: Fetch Payment Requirement</div>
                    <span id="step-status-3" class="step-status pending">Not started</span>
                </div>
                <p class="guide-text">What happens: request protected store endpoint and parse `Payment-Required` header on HTTP 402.</p>
                <p class="guide-text">On-chain interaction: none.</p>
                <div id="store-section">
                    <div class="data-row">
                        <span class="data-label">Store API URL</span>
                        <span class="data-value address"><input id="store-input" class="text-input" type="text" value="" placeholder="Current endpoint: https://tez402.bubbletez.com/api/weather" /></span>
                    </div>
                    <div class="custom-product-panel">
                        <div class="custom-product-title">Custom Token Product Demo</div>
                        <div class="custom-product-grid">
                            <div class="data-row">
                                <span class="data-label">Token Address</span>
                                <span class="data-value address"><input id="custom-token-input" class="text-input" type="text" placeholder="0x... ERC-20 token" /></span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Tier</span>
                                <span class="data-value address">
                                    <select id="custom-tier-select" class="text-input">
                                        <option value="tier_0_01">0.01</option>
                                        <option value="tier_0_1">0.1</option>
                                        <option value="tier_1_0">1.0</option>
                                    </select>
                                </span>
                            </div>
                        </div>
                        <div class="actions compact-actions">
                            <button id="custom-create-btn" type="button">CREATE PRODUCT</button>
                            <button id="custom-use-bbt-btn" type="button">USE BBT TOKEN</button>
                        </div>
                        <div id="custom-create-status" class="custom-create-status">No custom product created in this session.</div>
                    </div>
                    <div id="catalog-row" class="data-row hidden">
                        <span class="data-label">Catalog Item</span>
                        <span class="data-value address"><select id="catalog-select" class="text-input"></select></span>
                    </div>
                    <div class="data-row"><span class="data-label">Payment Amount</span><span id="amount-display" class="data-value">--</span></div>
                    <div class="data-row"><span class="data-label">Pay To</span><span id="payto-display" class="data-value address">--</span></div>
                </div>
                <div class="actions compact-actions">
                    <button id="requirements-btn">3. GET PAYMENT</button>
                </div>
                <pre id="requirements-response" class="response-preview">Awaiting response...</pre>
            </div>

            <div class="step-card" data-step="4">
                <div class="step-head">
                    <div class="step-title">Step 4: Approve Permit2</div>
                    <span id="step-status-4" class="step-status pending">Not started</span>
                </div>
                <p class="guide-text">What happens: set ERC-20 allowance to Permit2 for exact required amount.</p>
                <p class="guide-text">On-chain interaction: user sends approval transaction.</p>
                <div class="data-row">
                    <span class="data-label">Gas Payer</span>
                    <span class="data-value">
                        <div class="toggle-group">
                            <button id="gas-facilitator-btn" class="toggle-button active">FACILITATOR PAYS GAS (TEZ402)</button>
                        </div>
                    </span>
                </div>
                <div class="actions compact-actions">
                    <button id="approve-btn" class="hidden">4. APPROVE PERMIT2</button>
                </div>
                <div class="actions compact-actions">
                    <button id="token-toggle-btn">HIDE TOKEN DETAILS</button>
                </div>
                <div id="token-section">
                    <div class="data-row"><span class="data-label">Asset</span><span id="token-symbol-display" class="data-value">BBT</span></div>
                    <div class="data-row"><span class="data-label">Token Address</span><span id="token-address-display" class="data-value address">0x7EfE4bdd11237610bcFca478937658bE39F8dfd6</span></div>
                    <div class="data-row"><span class="data-label">Decimals</span><span id="token-decimals-display" class="data-value">18</span></div>
                    <div class="data-row"><span class="data-label">Balance</span><span id="balance-display" class="data-value">0.00</span></div>
                    <div class="data-row"><span class="data-label">ERC20 Allowance -&gt; Permit2</span><span id="allowance-display" class="data-value">0.00</span></div>
                    <div id="permit2-allowance-row" class="data-row hidden"><span class="data-label">Permit2 Allowance</span><span id="permit2-allowance-display" class="data-value">--</span></div>
                    <div class="data-row"><span class="data-label">Permit2 Expiration</span><span id="permit2-expiration-display" class="data-value">--</span></div>
                    <div class="data-row"><span class="data-label">Permit2 Nonce</span><span id="permit2-nonce-display" class="data-value">--</span></div>
                </div>
            </div>

            <div class="step-card" data-step="5">
                <div class="step-head">
                    <div class="step-title">Step 5: Sign &amp; Pay</div>
                    <span id="step-status-5" class="step-status pending">Not started</span>
                </div>
                <p class="guide-text">What happens: sign Permit2 typed data off-chain and submit `Payment-Signature`; facilitator settles on-chain.</p>
                <p class="guide-text">On-chain interaction: facilitator submits settlement transaction and pays gas.</p>
                <div class="actions compact-actions">
                    <button id="pay-btn" disabled>5. SIGN &amp; PAY</button>
                </div>
                <pre id="settle-response" class="response-preview">Awaiting response...</pre>
                <div id="settle-links" class="response-links hidden"></div>
            </div>

            <div id="console-output">
                <div class="log-entry log-info">&gt; SYSTEM READY</div>
                <div class="log-entry log-info">&gt; WAITING FOR CONNECTION...</div>
            </div>
        </div>
    </div>

    <div class="tab-panel hidden" data-panel="integration">
        <div class="content">
            <div class="guide-block">
                <div class="guide-title">Integration Summary</div>
                <div class="integration-grid">
                    <div class="integration-card">
                        <div class="guide-title">Client Must</div>
                        <ul class="guide-list">
                            <li>Detect `HTTP 402` from protected endpoint.</li>
                            <li>Parse `Payment-Required` payload and supported method.</li>
                            <li>Generate Permit2 signature matching exact requirement.</li>
                            <li>Retry request with `Payment-Signature` header.</li>
                        </ul>
                    </div>
                    <div class="integration-card">
                        <div class="guide-title">Store Must</div>
                        <ul class="guide-list">
                            <li>Issue x402 payment requirement with exact terms.</li>
                            <li>Validate signature payload and accepted requirement.</li>
                            <li>Call facilitator `/settle` for execution.</li>
                            <li>Release resource only on successful settlement.</li>
                        </ul>
                    </div>
                    <div class="integration-card">
                        <div class="guide-title">Facilitator Must</div>
                        <ul class="guide-list">
                            <li>Sponsor gas for supported settlement path.</li>
                            <li>Execute Permit2 settlement transaction.</li>
                            <li>Enforce proxy codehash allowlist.</li>
                            <li>Expose reliable health/supported/settle APIs.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="guide-block">
                <div class="guide-title">Payload Schemas (x402 v2 + Permit2)</div>
                <div class="guide-text">`Payment-Required` and `Payment-Signature` are base64-encoded JSON headers in this beta branch.</div>
                <pre>// TypeScript shapes used by this stack
type AcceptRequirement = {
  scheme: "exact";
  network: "eip155:42793";
  amount: string;
  payTo: string;
  asset: string;
  maxTimeoutSeconds: number;
  extra?: {
    assetTransferMethod?: "permit2";
    name?: string;
    decimals?: number;
  };
};

type PaymentRequired = {
  x402Version: 2;
  accepts: AcceptRequirement[];
  resource?: {
    url: string;
    mimeType?: string;
    description?: string;
  };
  error?: string;
};

type PaymentSignature = {
  x402Version: 2;
  scheme: "exact";
  network: "eip155:42793";
  accepted: AcceptRequirement;
  payload: {
    signature: string;
    permit2Authorization: {
      from: string;
      permitted: { token: string; amount: string };
      spender: string;
      nonce: string;
      deadline: string;
      witness: { to: string; validAfter: string; extra: string };
    };
  };
};</pre>
                <pre>// Permit2 typed data sent to signer.signTypedData(...)
const domain = {
  name: "Permit2",
  chainId: 42793,
  verifyingContract: "0x000000000022D473030F116dDEE9F6B43aC78BA3"
};

const types = {
  PermitWitnessTransferFrom: [
    { name: "permitted", type: "TokenPermissions" },
    { name: "spender", type: "address" },
    { name: "nonce", type: "uint256" },
    { name: "deadline", type: "uint256" },
    { name: "witness", type: "Witness" }
  ],
  TokenPermissions: [
    { name: "token", type: "address" },
    { name: "amount", type: "uint256" }
  ],
  Witness: [
    { name: "to", type: "address" },
    { name: "validAfter", type: "uint256" },
    { name: "extra", type: "bytes" }
  ]
};</pre>
            </div>

            <div class="guide-block" data-role-checklist="client">
                <div class="guide-title">Role Example: Client Integrator (TypeScript + ethers v6)</div>
                <pre>import { ethers } from "ethers";

const PERMIT2_ADDRESS = "0x000000000022D473030F116dDEE9F6B43aC78BA3";
const X402_PROXY = "0xB6FD384A0626BfeF85f3dBaf5223Dd964684B09E";
const CHAIN_ID = 42793;

const toBase64 = (obj: unknown) => {
  const bytes = new TextEncoder().encode(JSON.stringify(obj));
  return btoa(String.fromCharCode(...bytes));
};

const fromBase64 = (value: string) => {
  const bin = atob(value);
  const bytes = Uint8Array.from(bin, (ch) => ch.charCodeAt(0));
  return JSON.parse(new TextDecoder().decode(bytes));
};

export async function payAndRetry(protectedUrl: string, signer: ethers.Signer) {
  const first = await fetch(protectedUrl);
  if (first.status !== 402) {
    return first.json();
  }

  const required = fromBase64(first.headers.get("Payment-Required") || "");
  const accepted = required.accepts[0];
  if (!accepted || accepted.extra?.assetTransferMethod !== "permit2") {
    throw new Error("No supported permit2 requirement");
  }

  const now = Math.floor(Date.now() / 1000);
  const deadline = BigInt(now + Number(accepted.maxTimeoutSeconds || 60));
  const validAfter = BigInt(now);
  const nonce = ethers.toBigInt(ethers.hexlify(ethers.randomBytes(32)));

  const permit2Authorization = {
    from: await signer.getAddress(),
    permitted: { token: accepted.asset, amount: String(accepted.amount) },
    spender: X402_PROXY,
    nonce: nonce.toString(),
    deadline: deadline.toString(),
    witness: { to: accepted.payTo, validAfter: validAfter.toString(), extra: "0x" }
  };

  const signature = await signer.signTypedData(
    { name: "Permit2", chainId: CHAIN_ID, verifyingContract: PERMIT2_ADDRESS },
    {
      PermitWitnessTransferFrom: [
        { name: "permitted", type: "TokenPermissions" },
        { name: "spender", type: "address" },
        { name: "nonce", type: "uint256" },
        { name: "deadline", type: "uint256" },
        { name: "witness", type: "Witness" }
      ],
      TokenPermissions: [
        { name: "token", type: "address" },
        { name: "amount", type: "uint256" }
      ],
      Witness: [
        { name: "to", type: "address" },
        { name: "validAfter", type: "uint256" },
        { name: "extra", type: "bytes" }
      ]
    },
    {
      permitted: { token: accepted.asset, amount: BigInt(String(accepted.amount)) },
      spender: X402_PROXY,
      nonce,
      deadline,
      witness: { to: accepted.payTo, validAfter, extra: "0x" }
    }
  );

  const paymentPayload = {
    x402Version: 2,
    scheme: "exact",
    network: "eip155:42793",
    accepted,
    payload: { signature, permit2Authorization }
  };

  const paid = await fetch(protectedUrl, {
    headers: {
      "Payment-Signature": toBase64(paymentPayload),
      "X-GAS-PAYER": "facilitator"
    }
  });

  if (!paid.ok) {
    throw new Error(`Paid request failed: ${paid.status}`);
  }
  return paid.json();
}</pre>
            </div>

            <div class="guide-block hidden" data-role-checklist="store">
                <div class="guide-title">Role Example: Store Operator (Python / FastAPI)</div>
                <pre>import base64
import json
import os
import requests
from fastapi import FastAPI, Header, HTTPException

app = FastAPI()

FACILITATOR_URL = os.environ["FACILITATOR_URL"]
PAY_TO = os.environ["SERVER_WALLET"]
TOKEN = os.getenv("BBT_TOKEN", "0x7EfE4bdd11237610bcFca478937658bE39F8dfd6")
PROXY = os.getenv("X402_EXACT_PERMIT2_PROXY_ADDRESS", "0xB6FD384A0626BfeF85f3dBaf5223Dd964684B09E")
AMOUNT = "10000000000000000"  # 0.01 token at 18 decimals

def b64_json_encode(obj: dict) -> str:
    raw = json.dumps(obj, separators=(",", ":")).encode("utf-8")
    return base64.b64encode(raw).decode("utf-8")

def b64_json_decode(value: str) -> dict:
    return json.loads(base64.b64decode(value).decode("utf-8"))

def payment_required(resource_url: str) -> dict:
    return {
        "x402Version": 2,
        "accepts": [{
            "scheme": "exact",
            "network": "eip155:42793",
            "amount": AMOUNT,
            "payTo": PAY_TO,
            "asset": TOKEN,
            "maxTimeoutSeconds": 60,
            "extra": {"assetTransferMethod": "permit2"}
        }],
        "resource": {
            "url": resource_url,
            "mimeType": "application/json",
            "description": "Paid weather response"
        }
    }

@app.get("/api/weather")
def weather(
    payment_signature: str | None = Header(default=None, alias="Payment-Signature"),
    x_facilitator_url: str | None = Header(default=None, alias="X-Facilitator-Url")
):
    req = payment_required("https://your-store.example/api/weather")
    effective_facilitator = x_facilitator_url or FACILITATOR_URL

    if not payment_signature:
        raise HTTPException(
            status_code=402,
            detail="Payment required",
            headers={
                "Payment-Required": b64_json_encode(req),
                "X-Facilitator-Url": effective_facilitator
            }
        )

    payload = b64_json_decode(payment_signature)
    accepted = payload.get("accepted", {})
    permit2_auth = payload.get("payload", {}).get("permit2Authorization", {})

    if accepted.get("payTo", "").lower() != PAY_TO.lower():
        raise HTTPException(status_code=402, detail="Recipient mismatch")
    if accepted.get("asset", "").lower() != TOKEN.lower():
        raise HTTPException(status_code=402, detail="Asset mismatch")
    if str(accepted.get("amount")) != AMOUNT:
        raise HTTPException(status_code=402, detail="Amount mismatch")
    if permit2_auth.get("spender", "").lower() != PROXY.lower():
        raise HTTPException(status_code=402, detail="Invalid spender")

    settle_body = {
        "x402Version": 2,
        "paymentPayload": payload,
        "paymentRequirements": accepted
    }
    settle = requests.post(f"{effective_facilitator}/settle", json=settle_body, timeout=20)
    if settle.status_code >= 400:
        raise HTTPException(status_code=402, detail=f"Facilitator reject: {settle.text}")

    return {"ok": True, "settlement": settle.json()}</pre>
            </div>

            <div class="guide-block hidden" data-role-checklist="facilitator">
                <div class="guide-title">Role Example: Facilitator Host Ops Check (Python)</div>
                <pre>import json
import requests

FACILITATOR_URL = "https://exp-faci.bubbletez.com"

def require_ok(resp: requests.Response) -> dict:
    resp.raise_for_status()
    if not resp.text:
        return {}
    return resp.json()

def smoke_check():
    health = require_ok(requests.get(f"{FACILITATOR_URL}/health", timeout=10))
    supported = require_ok(requests.get(f"{FACILITATOR_URL}/supported", timeout=10))
    print("health:", json.dumps(health, indent=2))
    print("supported:", json.dumps(supported, indent=2))

    # For verify/settle testing, send:
    # {
    #   "x402Version": 2,
    #   "paymentPayload": {...decoded Payment-Signature...},
    #   "paymentRequirements": {...accepted requirement...}
    # }

if __name__ == "__main__":
    smoke_check()</pre>
            </div>
        </div>
    </div>

    <div class="tab-panel hidden" data-panel="setup">
        <div class="content">
            <div class="guide-block">
                <div class="guide-title">Setup Instructions</div>
                <div class="guide-text">Follow this sequence for a clean deployment.</div>
                <ol class="guide-list ordered-list setup-sequence">
                    <li>Clone repository and configure <code>.env</code> values.</li>
                    <li>Start Docker services and verify health checks.</li>
                    <li>Run demo or playbook tests against your endpoints.</li>
                    <li>Harden production deployment with your own domains and secrets.</li>
                </ol>
            </div>

            <details class="setup-detail">
                <summary>1. Docker Compose Stack</summary>
                <div class="detail-body">
                    <pre>docker compose -f docker-compose.wallet-poc.yml up -d --build</pre>
                    <p class="guide-text">Starts store API, store web, facilitator, and nginx proxy wiring.</p>
                </div>
            </details>

            <details class="setup-detail">
                <summary>2. .env Example (Store + Facilitator)</summary>
                <div class="detail-body">
                    <pre>FACILITATOR_URL=http://localhost:9090
RPC_URL=https://YOUR_ETHERLINK_RPC
CHAIN_ID=42793
SERVER_WALLET=0xYOUR_STORE_WALLET
STORE_PRIVATE_KEY=0xYOUR_STORE_PRIVATE_KEY
BBT_TOKEN=0x7EfE4bdd11237610bcFca478937658bE39F8dfd6
PERMIT2_ADDRESS=0x000000000022D473030F116dDEE9F6B43aC78BA3
X402_EXACT_PERMIT2_PROXY_ADDRESS=0xB6FD384A0626BfeF85f3dBaf5223Dd964684B09E
COMPLIANCE_PROVIDER=chainalysis
CHAINALYSIS_API_KEY=YOUR_CHAINALYSIS_KEY
PUBLIC_BASE_URL=</pre>
                </div>
            </details>

            <details class="setup-detail">
                <summary>3. .env.multitest Example</summary>
                <div class="detail-body">
                    <pre>WALLET_ONE_PRIVATE_KEY=0x...
WALLET_TWO_PRIVATE_KEY=0x...
FACILITATOR_URL=https://exp-faci.bubbletez.com
STORE_URL=https://tez402.bubbletez.com/api/weather
# Public endpoint reference
# FACILITATOR_URL=https://exp-faci.bubbletez.com
CHAIN_ID=42793</pre>
                </div>
            </details>

            <details class="setup-detail">
                <summary>4. Facilitator Config JSON</summary>
                <div class="detail-body">
                    <pre>{
  "port": 9090,
  "host": "0.0.0.0",
  "chains": {
    "eip155:42793": {
      "eip1559": true,
      "signers": ["$FACILITATOR_PRIVATE_KEY"],
      "rpc": [{ "http": "https://YOUR_ETHERLINK_RPC", "rate_limit": 100 }]
    }
  },
  "schemes": [
    { "id": "v2-eip155-exact", "chains": "eip155:42793", "enabled": true }
  ]
}</pre>
                </div>
            </details>

            <details class="setup-detail">
                <summary>5. Build/Run Facilitator Image</summary>
                <div class="detail-body">
                    <pre># Use published image
docker run --env-file .env -p 9090:9090 \
  -v $(pwd)/bbt_config.json:/app/bbt_config.json \
  ghcr.io/tzapac/tzapac-x402-permit2-facilitator:latest \
  --config /app/bbt_config.json

# Or build locally
docker build -t bbt-x402-facilitator:local -f bbt-x402-facilitator/Dockerfile.bbt bbt-x402-facilitator</pre>
                </div>
            </details>
        </div>
    </div>

    <div class="tab-panel hidden" data-panel="docs">
        <div class="content">
            <div class="guide-block">
                <div class="guide-title">Documentation</div>
                <ul class="guide-list">
                    <li class="doc-item"><a class="guide-link" href="https://github.com/coinbase/x402" target="_blank" rel="noopener noreferrer">x402 Upstream Spec / Reference Repo</a><span class="doc-note">Protocol reference and upstream implementation baseline.</span></li>
                    <li class="doc-item"><a class="guide-link" href="https://github.com/tzapac/tzapac-x402-permit2/blob/main/README.md" target="_blank" rel="noopener noreferrer">Repository README</a><span class="doc-note">Project overview, architecture, and top-level flow.</span></li>
                    <li class="doc-item"><a class="guide-link" href="https://github.com/tzapac/tzapac-x402-permit2/blob/main/docs/quick_start.md" target="_blank" rel="noopener noreferrer">Quick Start Guide</a><span class="doc-note">Fastest path to run the stack and validate endpoints.</span></li>
                    <li class="doc-item"><a class="guide-link" href="https://github.com/tzapac/tzapac-x402-permit2/blob/main/docs/client_guide.md" target="_blank" rel="noopener noreferrer">Client Integration Guide</a><span class="doc-note">How to detect 402, sign Permit2, and retry with Payment-Signature.</span></li>
                    <li class="doc-item"><a class="guide-link" href="https://github.com/tzapac/tzapac-x402-permit2/blob/main/docs/server_guide.md" target="_blank" rel="noopener noreferrer">Server Integration Guide</a><span class="doc-note">How servers issue requirements and gate protected resources.</span></li>
                    <li class="doc-item"><a class="guide-link" href="https://github.com/tzapac/tzapac-x402-permit2/blob/main/docs/store_operator_guide.md" target="_blank" rel="noopener noreferrer">Store Operator Guide</a><span class="doc-note">Catalog, product setup, and settlement orchestration details.</span></li>
                    <li class="doc-item"><a class="guide-link" href="https://github.com/tzapac/tzapac-x402-permit2/blob/main/docs/facilitator_hosting_guide.md" target="_blank" rel="noopener noreferrer">Facilitator Hosting Guide</a><span class="doc-note">Run your own facilitator with allowlists and operational controls.</span></li>
                    <li class="doc-item"><a class="guide-link" href="https://github.com/tzapac/tzapac-x402-permit2/blob/main/docs/facilitator_api_glossary.md" target="_blank" rel="noopener noreferrer">Facilitator API Glossary</a><span class="doc-note">Endpoint contracts and payload field definitions.</span></li>
                    <li class="doc-item"><a class="guide-link" href="https://github.com/tzapac/tzapac-x402-permit2/blob/main/docs/coinbase_comparison.md" target="_blank" rel="noopener noreferrer">Coinbase Comparison</a><span class="doc-note">Feature and flow parity notes versus Coinbase implementation.</span></li>
                    <li class="doc-item"><a class="guide-link" href="https://github.com/tzapac/tzapac-x402-permit2/blob/main/deployment_info.md" target="_blank" rel="noopener noreferrer">Deployment Info</a><span class="doc-note">Deployment assumptions, trust boundaries, and environment notes.</span></li>
                </ul>
            </div>
        </div>
    </div>

        <div class="tab-panel hidden" data-panel="legal">
        <div class="content">
            <div class="guide-block">
                <div class="guide-title">Legal / Terms</div>
                <div class="guide-text">Effective date: February 13, 2026</div>
                <p class="guide-text">Official legal terms are hosted here: <a class="guide-link" href="https://tzapac.notion.site/BubbleTez-Terms-of-Service-310c42813a8a80c5bceccc9ac7760cb7?pvs=143" target="_blank" rel="noopener noreferrer">BubbleTez Terms of Service</a>.</p>

<div class="guide-title">FAQ</div>
                <ul class="guide-list">
                    <li><strong>Who pays gas?</strong> The facilitator pays gas for settlement transactions.</li>
                    <li><strong>Are addresses screened?</strong> Yes, facilitator verify/settle checks enforce compliance screening before settlement.</li>
                    <li><strong>Do we log compliance events?</strong> Yes, this stack writes compliance audit JSONL entries for verify/settle and wallet-connect events.</li>
                    <li><strong>Can users reverse payment?</strong> No. Signed payments are treated as final and irreversible.</li>
                </ul>

                <div class="guide-title">1. Scope</div>
                <p class="guide-text">This frontend demonstrates a tez402 facilitator/store sample for Permit2-powered payment flows on Etherlink.</p>

                <div class="guide-title">2. Terms of use</div>
                <ul class="guide-list">
                    <li>You use the service in good faith and at your own risk.</li>
                    <li>You are responsible for safeguarding your wallet, keys, and signatures.</li>
                    <li>Verify contract addresses and facilitator endpoints before approving transactions.</li>
                    <li>Payments and wallet signing are executed only when you explicitly initiate actions in the UI.</li>
                </ul>

                <div class="guide-title">3. Privacy note</div>
                <ul class="guide-list">
                    <li>The client reads wallet account and request/response data needed to request payment requirements.</li>
                    <li>Store/facilitator operators receive wallet address, signed payment payloads, and request headers required to process settlement.</li>
                    <li>As with typical web services, endpoint operators can see network metadata such as source IP and user agent, and may retain request/compliance logs for operations and auditing.</li>
                    <li>This site uses Google Analytics (G-S1FE79SC2W) for anonymized usage statistics.</li>
                </ul>

                <div class="guide-title">4. Limitations and disclaimer</div>
                <p class="guide-text">This is a beta implementation. Network and infrastructure behavior can change. This is not financial advice and software is provided as-is for technical evaluation.</p>            </div>
        </div>
    </div>

    <footer>
        built with &lt;3 by tzapac |
        <a class="footer-link" href="https://github.com/tzapac/tzapac-x402-permit2/issues/new/choose" target="_blank" rel="noopener noreferrer">request pilot</a> |
        <a class="footer-link" href="https://github.com/tzapac/tzapac-x402-permit2" target="_blank" rel="noopener noreferrer">github</a>
    </footer>
</div>

<script src="/wallet_connect_poc.js?v=20260224-feedback-1"></script>
</body>
</html>
